var taxMapping = { "287": "Pseudomonas aeruginosa",
"562": "Escherichia coli",
"623": "Shigella flexneri",
"632": "Yersinia pestis",
"666": "Vibrio cholerae",
"686": "Vibrio cholerae O1 biovar El Tor",
"882": "Desulfovibrio vulgaris str. Hildenborough",
"1140": "Synechococcus elongatus PCC 7942",
"1392": "Bacillus anthracis",
"3055": "Chlamydomonas reinhardtii",
"3218": "Physcomitrella patens",
"3562": "Spinacia oleracea",
"3635": "Gossypium hirsutum",
"3694": "Populus trichocarpa",
"3702": "Arabidopsis thaliana",
"3847": "Glycine max",
"3880": "Medicago truncatula",
"3888": "Pisum sativum",
"4081": "Solanum lycopersicum",
"4097": "Nicotiana tabacum",
"4529": "Oryza rufipogon",
"4530": "Oryza sativa",
"4577": "Zea mays",
"4896": "Schizosaccharomyces pombe",
"5061": "Aspergillus niger",
"5062": "Aspergillus oryzae",
"5476": "Candida albicans",
"5478": "[Candida] glabrata",
"5480": "Candida parapsilosis",
"5664": "Leishmania major",
"5691": "Trypanosoma brucei",
"5702": "Trypanosoma brucei brucei",
"5722": "Trichomonas vaginalis",
"5759": "Entamoeba histolytica",
"5786": "Dictyostelium purpureum",
"5888": "Paramecium tetraurelia",
"6238": "Caenorhabditis briggsae",
"6239": "Caenorhabditis elegans",
"6412": "Helobdella robusta",
"6669": "Daphnia pulex",
"6945": "Ixodes scapularis",
"7070": "Tribolium castaneum",
"7091": "Bombyx mori",
"7159": "Aedes aegypti",
"7165": "Anopheles gambiae",
"7176": "Culex quinquefasciatus",
"7217": "Drosophila ananassae",
"7220": "Drosophila erecta",
"7222": "Drosophila grimshawi",
"7227": "Drosophila melanogaster",
"7230": "Drosophila mojavensis",
"7234": "Drosophila persimilis",
"7238": "Drosophila sechellia",
"7240": "Drosophila simulans",
"7244": "Drosophila virilis",
"7245": "Drosophila yakuba",
"7260": "Drosophila willistoni",
"7668": "Strongylocentrotus purpuratus",
"7719": "Ciona intestinalis",
"7739": "Branchiostoma floridae",
"7897": "Latimeria chalumnae",
"7918": "Lepisosteus oculatus",
"7955": "Danio rerio",
"7957": "Carassius auratus",
"7962": "Cyprinus carpio",
"7998": "Ictalurus punctatus",
"8018": "Oncorhynchus keta",
"8022": "Oncorhynchus mykiss",
"8030": "Salmo salar",
"8090": "Oryzias latipes",
"8128": "Oreochromis niloticus",
"8355": "Xenopus laevis",
"8364": "Xenopus tropicalis",
"8400": "Rana catesbeiana",
"8410": "Rugosa rugosa",
"8469": "Chelonia mydas",
"8496": "Alligator mississippiensis",
"8637": "Micrurus fulvius",
"8665": "Ophiophagus hannah",
"8729": "Crotalus adamanteus",
"8801": "Struthio camelus",
"8839": "Anas platyrhynchos",
"8843": "Anser anser",
"8932": "Columba livia",
"8969": "Haliaeetus albicilla",
"9031": "Gallus gallus",
"9091": "Coturnix coturnix",
"9103": "Meleagris gallopavo",
"9209": "Phalacrocorax carbo",
"9218": "Phoenicopterus ruber ruber",
"9233": "Aptenodytes forsteri",
"9238": "Pygoscelis adeliae",
"9244": "Calypte anna",
"9258": "Ornithorhynchus anatinus",
"9305": "Sarcophilus harrisii",
"9361": "Dasypus novemcinctus",
"9402": "Pteropus alecto",
"9430": "Desmodus rotundus",
"9483": "Callithrix jacchus",
"9490": "Saguinus oedipus",
"9521": "Saimiri sciureus",
"9523": "Plecturocebus moloch",
"9534": "Chlorocebus aethiops",
"9541": "Macaca fascicularis",
"9543": "Macaca fuscata fuscata",
"9544": "Macaca mulatta",
"9545": "Macaca nemestrina",
"9555": "Papio anubis",
"9557": "Papio hamadryas",
"9580": "Hylobates lar",
"9595": "Gorilla gorilla gorilla",
"9597": "Pan paniscus",
"9598": "Pan troglodytes",
"9600": "Pongo pygmaeus",
"9601": "Pongo abelii",
"9606": "Homo sapiens",
"9615": "Canis lupus familiaris",
"9646": "Ailuropoda melanoleuca",
"9669": "Mustela putorius furo",
"9685": "Felis catus",
"9739": "Tursiops truncatus",
"9785": "Loxodonta africana",
"9796": "Equus caballus",
"9823": "Sus scrofa",
"9913": "Bos taurus",
"9915": "Bos indicus",
"9925": "Capra hircus",
"9940": "Ovis aries",
"9986": "Oryctolagus cuniculus",
"9995": "Marmota monax",
"10029": "Cricetulus griseus",
"10030": "Cricetulus longicaudatus",
"10036": "Mesocricetus auratus",
"10090": "Mus musculus",
"10096": "Mus spretus",
"10116": "Rattus norvegicus",
"10141": "Cavia porcellus",
"10181": "Heterocephalus glaber",
"10228": "Trichoplax adhaerens",
"10254": "Vaccinia virus WR",
"10299": "Human alphaherpesvirus 1 strain 17",
"10377": "Human herpesvirus 4 strain B95-8",
"10665": "Escherichia virus T4",
"11108": "Hepatitis C virus (isolate H)",
"11676": "Human immunodeficiency virus 1",
"11706": "HIV-1 M:B_HXB2R",
"13616": "Monodelphis domestica",
"13735": "Pelodiscus sinensis",
"15368": "Brachypodium distachyon",
"28285": "Human adenovirus 5",
"28377": "Anolis carolinensis",
"29760": "Vitis vinifera",
"30419": "Opisthocomus hoazin",
"30455": "Fulmarus glacialis",
"30521": "Bos grunniens",
"30611": "Otolemur garnettii",
"31033": "Takifugu rubripes",
"33548": "Colobus guereza",
"34903": "Trachemys scripta",
"35024": "Crotalus horridus",
"35128": "Thalassiosira pseudonana",
"36300": "Pelecanus crispus",
"36329": "Plasmodium falciparum 3D7",
"36911": "Clavispora lusitaniae",
"37040": "Gavia stellata",
"37293": "Aotus nancymaae",
"39432": "Saimiri boliviensis boliviensis",
"39946": "Oryza sativa Indica Group",
"39947": "Oryza sativa Japonica Group",
"41063": "Penicilliopsis zonata",
"42374": "Candida dubliniensis",
"42415": "Sigmodon hispidus",
"43179": "Ictidomys tridecemlineatus",
"43455": "Cathartes aura",
"44689": "Dictyostelium discoideum",
"45351": "Nematostella vectensis",
"46245": "Drosophila pseudoobscura pseudoobscura",
"46472": "Aspergillus versicolor",
"48698": "Poecilia formosa",
"50402": "Charadrius vociferus",
"54126": "Pristionchus pacificus",
"54374": "Mesitornis unicolor",
"54380": "Cariama cristata",
"54383": "Eurypyga helias",
"55661": "Cuculus canorus",
"56313": "Tyto alba",
"57068": "Acanthisitta chloris",
"57397": "Apaloderma vittatum",
"57412": "Colius striatus",
"57421": "Merops nubicus",
"57486": "Mus musculus molossinus",
"59463": "Myotis lucifugus",
"59479": "Rhinolophus ferrumequinum",
"59729": "Taeniopygia guttata",
"59894": "Ficedula albicollis",
"61853": "Nomascus leucogenys",
"64091": "Halobacterium salinarum NRC-1",
"69014": "Thermococcus kodakarensis KOD1",
"69293": "Gasterosteus aculeatus",
"70601": "Pyrococcus horikoshii OT3",
"71421": "Haemophilus influenzae Rd KW20",
"72004": "Bos mutus",
"74940": "Oncorhynchus tshawytscha",
"75750": "Aspergillus sydowii",
"81824": "Monosiga brevicollis",
"83331": "Mycobacterium tuberculosis CDC1551",
"83332": "Mycobacterium tuberculosis H37Rv",
"83333": "Escherichia coli K-12",
"83334": "Escherichia coli O157:H7",
"85066": "Corvus brachyrhynchos",
"85962": "Helicobacter pylori 26695",
"89462": "Bubalus bubalis",
"93061": "Staphylococcus aureus subsp. aureus NCTC 8325",
"93934": "Coturnix japonica",
"94827": "Tinamus guttatus",
"97097": "Phaethon lepturus",
"99287":
 "Salmonella enterica subsp. enterica serovar Typhimurium str. LT2",
"99883": "Tetraodon nigroviridis",
"100226": "Streptomyces coelicolor A3(2)",
"100784": "Balearica regulorum gibbericeps",
"109478": "Myotis brandtii",
"118200": "Picoides pubescens",
"121530": "Tauraco erythrolophus",
"122586": "Neisseria meningitidis MC58",
"128390": "Nipponia nippon",
"148305": "Pyricularia grisea",
"160488": "Pseudomonas putida KT2440",
"162425": "Aspergillus nidulans",
"164328": "Phytophthora ramorum",
"167879": "Colwellia psychrerythraea 34H",
"169963": "Listeria monocytogenes EGD-e",
"170187": "Streptococcus pneumoniae TIGR4",
"171101": "Streptococcus pneumoniae R6",
"175836": "Buceros rhinoceros silvestris",
"176057": "Nestor notabilis",
"176299": "Agrobacterium fabrum str. C58",
"178306": "Pyrobaculum aerophilum str. IM2",
"184922": "Giardia lamblia ATCC 50803",
"185431": "Trypanosoma brucei brucei TREU927",
"187382": "Chlamydotis macqueenii",
"188344": "Leptosomus discolor",
"188379": "Egretta garzetta",
"188937": "Methanosarcina acetivorans C2A",
"189518": "Leptospira interrogans serovar Lai str. 56601",
"190304": "Fusobacterium nucleatum subsp. nucleatum ATCC 25586",
"190485": "Xanthomonas campestris pv. campestris str. ATCC 33913",
"190650": "Caulobacter vibrioides CB15",
"195099": "Campylobacter jejuni RM1221",
"195103": "Clostridium perfringens ATCC 13124",
"196600": "Vibrio vulnificus YJ016",
"196627": "Corynebacterium glutamicum ATCC 13032",
"198094": "Bacillus anthracis str. Ames",
"198628": "Dickeya dadantii 3937",
"205920": "Ehrlichia chaffeensis str. Arkansas",
"208964": "Pseudomonas aeruginosa PAO1",
"211044": "Influenza A virus (A/Puerto Rico/8/1934(H1N1))",
"211586": "Shewanella oneidensis MR-1",
"212042": "Anaplasma phagocytophilum str. HZ",
"214684": "Cryptococcus neoformans var. neoformans JEC21",
"220664": "Pseudomonas protegens Pf-5",
"222891": "Neorickettsia sennetsu str. Miyayama",
"223283": "Pseudomonas syringae pv. tomato str. DC3000",
"224308": "Bacillus subtilis subsp. subtilis str. 168",
"224324": "Aquifex aeolicus VF5",
"224326": "Borreliella burgdorferi B31",
"224911": "Bradyrhizobium diazoefficiens USDA 110",
"225400": "Myotis davidii",
"226186": "Bacteroides thetaiotaomicron VPI-5482",
"226900": "Bacillus cereus ATCC 14579",
"227321": "Aspergillus nidulans FGSC A4",
"227377": "Coxiella burnetii RSA 493",
"228405": "Hyphomonas neptunium ATCC 15444",
"237561": "Candida albicans SC5314",
"237631": "Ustilago maydis 521",
"240206": "Pterocles gutturalis",
"242507": "Pyricularia oryzae 70-15",
"243090": "Rhodopirellula baltica SH 1",
"243164": "Dehalococcoides mccartyi 195",
"243230": "Deinococcus radiodurans R1",
"243231": "Geobacter sulfurreducens PCA",
"243232": "Methanocaldococcus jannaschii DSM 2661",
"243233": "Methylococcus capsulatus str. Bath",
"243273": "Mycoplasma genitalium G37",
"243274": "Thermotoga maritima MSB8",
"243277": "Vibrio cholerae O1 biovar El Tor str. N16961",
"246194": "Carboxydothermus hydrogenoformans Z-2901",
"246196": "Mycolicibacterium smegmatis MC2 155",
"246200": "Ruegeria pomeroyi DSS-3",
"246437": "Tupaia chinensis",
"251221": "Gloeobacter violaceus PCC 7421",
"264730": "Pseudomonas savastanoi pv. phaseolicola 1448A",
"265669": "Listeria monocytogenes serotype 4b str. F2365",
"266834": "Sinorhizobium meliloti 1021",
"272561": "Chlamydia trachomatis D/UW-3/CX",
"272634": "Mycoplasma pneumoniae M129",
"273057": "Saccharolobus solfataricus P2",
"279965": "Antrostomus carolinensis",
"284591": "Yarrowia lipolytica CLIB122",
"284592": "Debaryomyces hansenii CBS767",
"284593": "[Candida] glabrata CBS 138",
"284811": "Eremothecium gossypii ATCC 10895",
"289376": "Thermodesulfovibrio yellowstonii DSM 11347",
"294746": "Meyerozyma guilliermondii ATCC 6260",
"294747": "Candida tropicalis MYA-3404",
"294748": "Candida albicans WO-1",
"300852": "Thermus thermophilus HB8",
"306902": "Clavispora lusitaniae ATCC 42720",
"321614": "Parastagonospora nodorum SN15",
"324602": "Chloroflexus aurantiacus J-10-fl",
"328815": "Manacus vitellinus",
"330879": "Aspergillus fumigatus Af293",
"331117": "Aspergillus fischeri NRRL 181",
"332952": "Aspergillus flavus NRRL3357",
"333760": "Human papillomavirus type 16",
"341663": "Aspergillus terreus NIH2624",
"344612": "Aspergillus clavatus NRRL 1",
"345073": "Vibrio cholerae O395",
"345573": "Podiceps cristatus",
"347515": "Leishmania major strain Friedlin",
"356411": "Hepatitis C virus JFH-1",
"367110": "Neurospora crassa OR74A",
"369515": "Sylvirana spinulosa",
"374847": "Candidatus Korarchaeum cryptofilum OPF8",
"379508": "Lodderomyces elongisporus NRRL YB-4239",
"418459": "Puccinia graminis f. sp. tritici CRL 75-36-700-3",
"419612": "Camelus ferus",
"425011": "Aspergillus niger CBS 513.88",
"436308": "Nitrosopumilus maritimus SCM1",
"441771": "Clostridium botulinum A str. Hall",
"441894": "Struthio camelus australis",
"451804": "Aspergillus fumigatus A1163",
"452646": "Neovison vison",
"510516": "Aspergillus oryzae RIB40",
"515635": "Dictyoglomus turgidum DSM 6724",
"559292": "Saccharomyces cerevisiae S288C",
"578454": "Candida parapsilosis CDC317",
"602072": "Aspergillus carbonarius ITEM 5010",
"665079": "Sclerotinia sclerotiorum 1980 UF-70",
"684364": "Batrachochytrium dendrobatidis JAM81",
"690307": "Aspergillus aculeatus ATCC 16872",
"746128": "Aspergillus fumigatus",
"767769": "Aspergillus brasiliensis CBS 101740",
"767770": "Aspergillus tubingensis CBS 134.48",
"885580": "Fukomys damarensis",
"1033177": "Aspergillus kawachii IFO 4308",
"1073089": "Aspergillus wentii DTO 134E9",
"1111708": "Synechocystis sp. PCC 6803 substr. Kazusa",
"1136231": "Candida orthopsilosis Co 90-125",
"1137211": "Aspergillus luchuensis CBS 106.47",
"1160497": "Aspergillus glaucus CBS 516.65" }




var stats_summaries = { }


var aggregated_stats_url = "https://geneontology-archive.s3.amazonaws.com/aggregated-go-stats-summaries.json"
// var aggregated_stats_url = "http://current.geneontology.org/release_stats/aggregated-go-stats-summaries.json";

function get_aggregated_stats() {
    var query = axios.get(aggregated_stats_url);
    return query;
}


function get_stats(releases) {
    var axiosQueries = [];
    for (var release of releases) {
        axiosQueries.push(axios.get(release.stats));
    }
    return axios.all(axiosQueries);
}




// build the reverse map
var annotatedSpecies = { };
Object.keys(taxMapping).forEach(key => {
    annotatedSpecies[taxMapping[key]] = key;
});

var speciesList = [];
Object.keys(annotatedSpecies).forEach(key => {
    speciesList.push(key);
});
speciesList.sort();

var referenceSpecies = {
    "Drosophila melanogaster": 7227,
    "Caenorhabditis elegans": 6239,
    "Saccharomyces cerevisiae": 559292,
    "Dictyostelium": 44689,
    "Arabidopsis thaliana": 3702,
    "Danio rerio": 7955,
    "Mouse": 10090,
    "Human": 9606,
    "Schizosaccharomyces pombe": 4896,
    "E.coli": 83333,
    "Rat": 10116
};

var evidenceGroups = {
    "EXP": ["EXP", "IDA", "IEP", "IGC", "IGI", "IKR", "IMP", "IPI"],
    "HTP": ["HDA", "HEP", "HGI", "HMP", "HTP"],
    "IBA": ["IBA"],
    "IEA": ["IEA"],
    "ND": ["ND"],
    "OTHER": ["IC", "ISA", "ISM", "ISO", "ISS", "NAS", "RCA", "TAS"]
};

var reverseGroups = { };
Object.keys(evidenceGroups).forEach(key => {
    var list = evidenceGroups[key];
    for(var gp of list) {
        reverseGroups[gp] = key;
    }
});

var all_stats = undefined;

function getSpeciesLabel(id) {
    var url = "https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=taxonomy&id=" + id;
    axios.get(url);
}

function changeSpecies() {
    var selected = document.getElementById("select-species").value;
    if (selected && selected != "refgenomes") {
        selected = JSON.parse(selected);
    } else {
        selected = referenceSpecies;
    }
    // console.log("change species: ", selected);
    drawSpeciesOverTime(all_stats, selected);
}

function get_releases() {
    var getListUrl = 'https://8aaizex1i1.execute-api.us-east-1.amazonaws.com/Prod/go/release/list';
    return axios.get(getListUrl);
}

function get_new_releases() {
    var getListUrl = 'https://e5z36pqyqg.execute-api.us-east-1.amazonaws.com/Prod/go/releases/files';
    return axios.get(getListUrl);
}

function get_stats(releases) {
    var axiosQueries = [];
    for (var release of releases) {
        axiosQueries.push(axios.get(release.stats));
    }
    return axios.all(axiosQueries);
}

function get_ontology_stats(new_releases) {
    var axiosQueries = [];
    for (var release of new_releases) {
        if(release["go-last-changes-summary"])
            axiosQueries.push(axios.get(release["go-last-changes-summary"]));
    }
    return axios.all(axiosQueries);
}


function openInNewTab(url) {
    var win = window.open(url, '_blank');
    win.focus();
}

function drawReleaseProperty(release_stats, field, fieldLabel, eltID, useLabels = false, sliceVisibility = 0, grouping = undefined) {
    var data_stats = release_stats.annotations[field];

    // console.log("RELEASE STATS: ", release_stats);
    // console.log("data field: ", data_stats);
    var array = [];
    if(grouping) {
        var data = {};
        Object.keys(data_stats).forEach(fieldItem => {
            if(!data[grouping[fieldItem]]) {
                data[grouping[fieldItem]] = 0;
            }
            data[grouping[fieldItem]] += data_stats[fieldItem];
        });
        // console.log("new data: ", data);
        Object.keys(data).forEach(fieldItem => {
            array.push([ fieldItem, data[fieldItem] ]);
        });
    } else {
        Object.keys(data_stats).forEach(fieldItem => {
            if(field.includes("species")) {
                array.push([taxMapping[fieldItem.substring(fieldItem.indexOf(":") + 1)] , data_stats[fieldItem] ] );
            } else {
                array.push([fieldItem , data_stats[fieldItem] ] );
            }
        })
    }

    var prepared = [[fieldLabel, 'Annotations']].concat(array);
    var data = google.visualization.arrayToDataTable(prepared);

    var options = {
        legend: { position: 'bottom' },
        crosshair: { focused: { color: '#3bc', opacity: 0.8 } },
        // curveType: 'function',
        dataOpacity: 1.0,
        lineWidth: 2.0,
        pointSize: 3.0,
        pointShape: 'circle',
        width: 1200,
        height: 600,
        titlePosition: 'none'
    };

    if(useLabels) {
        options['pieSliceText'] = 'label';
    }

    if(sliceVisibility > 0) {
        options['sliceVisibilityThreshold'] = sliceVisibility;
    }

    var chart = new google.visualization.PieChart(document.getElementById(eltID));
    chart.draw(data, options);            

    google.visualization.events.addListener(chart, 'select', function() {
        var selectedItem = chart.getSelection()[0];
        var selectedTerm = prepared[selectedItem.row + 1];
        // console.log("species : " , selectedTerm);
        if(field.includes("species")) {
            var url = "http://amigo.geneontology.org/amigo/search/annotation?fq=taxon_subset_closure_label:\"" + selectedTerm[0] + "\"";
            openInNewTab(url);
        } else if(field.includes("evidence")) {
            // console.log(evidenceGroups[selectedTerm[0]]);
            var selection = evidenceGroups[selectedTerm[0]].join("\" \"");
            var url = "http://amigo.geneontology.org/amigo/search/annotation?fq=evidence_type:(" + selection + ")";
            openInNewTab(url);
        }
    });

}



function drawSpeciesOverTime(all_stats, species_set) {
    var selected = [];
    var selectedLabels = [];
    Object.keys(species_set).forEach(species => {
        selected.push("NCBITaxon:" + species_set[species]);
        selectedLabels.push(species + " (" + species_set[species] + ")");
    });

    var prepared = all_stats.map(release => {
        var array = [];
        for (var species of selected) {
            var nb = release.annotations.by_species[species];
            if (!nb) {
                nb = 0;
            }
            array.push(nb);
        }
        return [release.release_date].concat(array);
    })

    prepared = [['Release'].concat(selectedLabels)].concat(prepared);
    // console.log("prepared: ", prepared);
    var data = google.visualization.arrayToDataTable(prepared);

    var chart = new google.visualization.LineChart(document.getElementById('graph-species-ot'));
    var options = {
        legend: { position: 'bottom' },
        crosshair: { focused: { color: '#3bc', opacity: 0.8 } },
        // curveType: 'function',
        dataOpacity: 1.0,
        lineWidth: 2.0,
        pointSize: 3.0,
        pointShape: 'circle',
        width: 1000,
        height: 600,
        chartArea : {'width': '85%', 'height': '80%'},
        titlePosition: 'none'
    };
    chart.draw(data, options);
}

function createSpeciesSelect() {
    var select = document.getElementById("select-species");
    var count = 0;
    
    var option = new Option("Representative species", count++);
    option.value = "refgenomes";
    select.options[select.options.length] = option;

    for(var species of speciesList) {
        var option = new Option(species, count++);
        option.value = "{ \"" + species + "\": \"" + annotatedSpecies[species] + "\" }";
        select.options[select.options.length] = option
    }    
}

function drawTermsByAspectOT(ontology_stats, eltID) {

    var prepared = ontology_stats.map(release => {
        // return [ release.current.release_date.substring(9) , release.current.valid_terms , release.current.obsoleted_terms, release.current.merged_terms , release.current.biological_processes , release.current.molecular_functions , release.current.cellular_components];
        return [ release.current.release_date.substring(9) , release.current.valid_terms , release.current.biological_processes , release.current.molecular_functions , release.current.cellular_components];
    })
    // console.log(prepared);
    // prepared = [['Release', 'Valid', 'Obsoleted', 'Merged', 'BP', 'MF', 'CC']].concat(prepared);
    prepared = [['Release', 'Valid', 'BP', 'MF', 'CC']].concat(prepared);
    // console.log("prepared: ", prepared);
    var data = google.visualization.arrayToDataTable(prepared);

    var chart = new google.visualization.LineChart(document.getElementById(eltID));
    var options = {
        legend: { position: 'bottom' },
        crosshair: { focused: { color: '#3bc', opacity: 0.8 } },
        // curveType: 'function',
        dataOpacity: 1.0,
        lineWidth: 2.0,
        pointSize: 4.0,
        pointShape: 'circle',
        width: 1000,
        height: 600,
        chartArea : {'width': '85%', 'height': '80%'},
        titlePosition: 'none'
    };
    chart.draw(data, options);
}

function drawTermsAlterationsOT(ontology_stats, eltID, addXRefs) {

    var prepared;
    if(addXRefs) {
        prepared = ontology_stats.map(release => {
            return [ release.current.release_date.substring(9) , release.created_terms ,  release.obsoleted_terms , release.merged_terms, release.terms_structural_changes, release.terms_meta_changes, release.terms_meta_noxrefs_changes ];
        })
        prepared = [['Release', 'Δ created', 'Δ obsoleted', 'Δ merged', 'Δ structures', 'Δ metas', 'Δ metas NOREF']].concat(prepared);
    } else {
        prepared = ontology_stats.map(release => {
            return [ release.current.release_date.substring(9) , release.created_terms ,  release.obsoleted_terms , release.merged_terms, release.terms_structural_changes, release.terms_meta_noxrefs_changes ];
        })
        prepared = [['Release', 'Δ created', 'Δ obsoleted', 'Δ merged', 'Δ structures', 'Δ metas NOREF']].concat(prepared);
    }
    // console.log("prepared: ", prepared);
    var data = google.visualization.arrayToDataTable(prepared);

    var chart = new google.visualization.LineChart(document.getElementById(eltID));
    var options = {
        legend: { position: 'bottom' },
        crosshair: { focused: { color: '#3bc', opacity: 0.8 } },
        // curveType: 'function',
        dataOpacity: 1.0,
        lineWidth: 2.0,
        pointSize: 4.0,
        pointShape: 'circle',
        width: 1000,
        height: 600,
        chartArea : {'width': '85%', 'height': '80%'},
        vAxis: {
            viewWindow: {
                min: 0,
                max: addXRefs ? 2500 : 350
            }
        },
        titlePosition: 'none'
    };
    chart.draw(data, options);
}

var pieHole = 0.3;
var chartFontSize = 14;
var smallChartWidth = 350;
var smallChartHeight = 350;

var smallChartTitlePosition = 'none';

var smallChartArea = {
    'width': '300', 
    'height': '220',
    top: 10
};

var smallChartAreaPie = {
    'width': '300', 
    'height': '280',
    top: 10
};

var smallChartTitleStyle = {
    fontSize: 18,
    color: "#36c",
    bold: true
}

var chartOTWidth = 1080;
var chartOTHeight = 500;

var chartMidWidth = 380;
var chartMidHeight = 380;

function simpleDate(date) {
    var split = date.split("-");
    return split[0] + "-" + split[1];
}

function drawTermAspectOT(statsObj) {
    var stats = statsObj["stats"];
    var array = [];
    var header = ["release", "# BP", "# MF", "# CC"];
    array.push(header);
    for(var release of stats) {
        array.push([simpleDate(release["release_date"]), release["ontology"]["biological_process_terms"], release["ontology"]["molecular_function_terms"], release["ontology"]["cellular_component_terms"]])
    }
    var data = google.visualization.arrayToDataTable(array);

    var options = {
          legend: { position: 'bottom' },
          crosshair: { focused: { color: '#3bc', opacity: 0.8 } },
          // curveType: 'function',
          dataOpacity: 1.0,
          width: chartMidWidth,
          height: chartMidHeight,
          chartArea : {'width': '75%', 'height': '75%', top: 15, right: 10},
          titlePosition: 'none',
          pointVisible: true,
          pointSize: 4          
        //   isStacked: true

      };

    var chart = new google.visualization.LineChart(document.getElementById('graph-ontology-terms-aspect-OT'));        
    chart.draw(data, options);
}

function drawTermStateOT(statsObj) {
    var stats = statsObj["stats"];
    var array = [];
    var header = ["release", "# created", "# merged", "# obsoleted"];
    array.push(header);

    for(var i = 1; i < stats.length; i++) {
        array.push([
            simpleDate(stats[i]["release_date"]), 
            stats[i]["ontology"]["changes_created_terms"], 
            stats[i]["ontology"]["changes_merged_terms"], 
            stats[i]["ontology"]["changes_obsolete_terms"]
        ])
    }
    var data = google.visualization.arrayToDataTable(array);

    var options = {
          legend: { position: 'bottom' },
          crosshair: { focused: { color: '#3bc', opacity: 0.8 } },
          // curveType: 'function',
          dataOpacity: 1.0,
          width: chartMidWidth,
          height: chartMidHeight,
          chartArea : {'width': '85%', 'height': '75%', top: 15, right: 10},
          titlePosition: 'none',
          isStacked: true
      };

    var chart = new google.visualization.ColumnChart(document.getElementById('graph-ontology-terms-changes-OT'));        
    chart.draw(data, options);
}



function drawAnnotationAspectOT(statsObj) {
    var stats = statsObj["stats"];
    var array = [];
    var header = ["release", "# BP", "# MF", "# CC"];
    array.push(header);
    for(var release of stats) {
        array.push([simpleDate(release["release_date"]), release["annotations"]["by_aspect"]["P"], release["annotations"]["by_aspect"]["F"], release["annotations"]["by_aspect"]["C"]])
    }
    var data = google.visualization.arrayToDataTable(array);

    var options = {
          legend: { position: 'bottom' },
          crosshair: { focused: { color: '#3bc', opacity: 0.8 } },
          // curveType: 'function',
          dataOpacity: 1.0,
          width: chartOTWidth,
          height: chartOTHeight,
          chartArea : {'width': '85%', 'height': '75%', top: 15},
          titlePosition: 'none',
          isStacked: true,
      };

    var chart = new google.visualization.ColumnChart(document.getElementById("graph-annotation-aspect-OT"));        
    chart.draw(data, options);
}


function drawAnnotationEvidenceOT(statsObj, selectedSpecies = null) {
    // console.log("drawing annotation evidence OT for species " , selectedSpecies);
    var stats = statsObj["stats"];

    var clusters = statsObj.evidence_clusters;
    var header = ["Release"].concat(clusters);

    var array = [];
    array.push(header);
    for(var release of stats) {
        var line = [simpleDate(release["release_date"])];
        for(var cluster of clusters) {
            var val = undefined;
            if(selectedSpecies) {
                val = cluster in release["annotations"]["by_model_organism"][selectedSpecies]["by_evidence_cluster"] ? release["annotations"]["by_model_organism"][selectedSpecies]["by_evidence_cluster"][cluster]["A"] : 0;
            } else {
                val = cluster in release["annotations"]["by_evidence_cluster"] ? release["annotations"]["by_evidence_cluster"][cluster] : 0;
            }
            line.push(val);
        }
        array.push(line);
    }
    var data = google.visualization.arrayToDataTable(array);

    var options = {
          legend: { position: 'bottom' },
          crosshair: { focused: { color: '#3bc', opacity: 0.8 } },
          // curveType: 'function',
          dataOpacity: 1.0,
          width: Math.round(chartOTWidth * 0.66),
          height: Math.round(chartOTHeight * 0.66),
          chartArea : {'width': '85%', 'height': '75%', top: 15},
          titlePosition: 'none',
          isStacked: true
      };

    // LineChart, AreaChart
    var chart = new google.visualization.ColumnChart(document.getElementById("graph-annotation-evidence-OT"));        
    chart.draw(data, options);
}


function drawAnnotationBioentityOT(statsObj) {
    var stats = statsObj["stats"];
    var array = [];
    var header = ["release", "# bioentities"];
    array.push(header);
    for(var release of stats) {
        array.push([release["release_date"], release["bioentities"]["total"]]);
    }
    var data = google.visualization.arrayToDataTable(array);

    var options = {
          legend: { position: 'bottom' },
          crosshair: { focused: { color: '#3bc', opacity: 0.8 } },
          dataOpacity: 1.0,
          width: chartOTWidth,
          height: chartOTHeight,
          chartArea : {'width': '90%', 'height': '75%', top: 15},
          titlePosition: 'none'
      };

    var chart = new google.visualization.LineChart(document.getElementById("graph-annotated-bioentity-OT"));        
    chart.draw(data, options);    
}



function drawReferencePMIDsOT(statsObj) {
    var stats = statsObj["stats"];
    var array = [];
    var header = ["release", "# PMIDs"];
    array.push(header);
    for(var release of stats) {
        array.push([simpleDate(release["release_date"]), release["references"]["pmids"]["total"]])
    }
    var data = google.visualization.arrayToDataTable(array);

    var options = {
          legend: { position: 'none' },
          crosshair: { focused: { color: '#3bc', opacity: 0.8 } },
          dataOpacity: 1.0,
          width: chartMidWidth,
          height: chartMidWidth,
          chartArea : {'width': '85%', 'height': '75%', top: 15, right: 0},
          titlePosition: 'none',
          pointVisible: true,
          pointSize: 4          
      };

    var chart = new google.visualization.LineChart(document.getElementById("graph-references-pmid-OT"));        
    chart.draw(data, options);
}

function drawOntologyCharts(statsObj, release) {
    drawTermAspectOT(statsObj);
    drawTermStateOT(statsObj);
}



function getRelease(statsObj, release_date) {
    var release = statsObj.stats.filter(elt => {
        return elt.release_date == release_date;
    })
    return release[0];
}

function getLastRelease(statsObj) {
    return statsObj.stats[statsObj.stats.length - 1];
}


/**
 * 
 * @param {*} statsObj 
 * @param {*} aspect : A, P, F, C
 * @param {*} release_date 
 */
function drawRefGenomeCoverageByBioentity(statsObj, aspect, release) {
    var stats = statsObj["stats"];
    
    var clusters = Object.values(statsObj.bioentity_types);
    var header = ["Bioentity"].concat(clusters);

    var array = [];
    array.push(header);
    for(var genome_id in release.bioentities.by_model_organism) {
        var genome = release.bioentities.by_model_organism[genome_id];
        var line = [];
        line.push(genome_id.split("|")[1]);
        for(var cluster of clusters) {
            var value = cluster in genome ? genome[cluster][aspect] : 0;
            line.push(value);
        }        
        array.push(line)
    }
    var data = google.visualization.arrayToDataTable(array);

    var options = {
          title: 'Evolution of GO meta statements, xrefs and relations',
          subtitle: '',
          legend: { position: 'bottom' },
          crosshair: { focused: { color: '#3bc', opacity: 0.8 } },
          dataOpacity: 1.0,
          width: 1000,
          height: 600,
          bar : { groupWidth: '75%' },
          chartArea : {'width': '90%', 'height': '75%', top: 15},
          titlePosition: 'none'
      };

    var chart = new google.visualization.ColumnChart(document.getElementById('graph-genome-bioentity-coverage'));        
    chart.draw(data, options);        
}

function drawRefGenomeCoverageByEvidence(statsObj, aspect, release) {
    var stats = statsObj["stats"];
    
    var clusters = Object.keys(release.annotations.by_evidence_cluster);
    var header = ["Evidence"].concat(clusters);

    var array = [];
    array.push(header);
    for(var genome_id in release.annotations.by_model_organism) {
        var genome = release.annotations.by_model_organism[genome_id];
        var line = [];
        line.push(genome_id.split("|")[1]);
        for(var cluster of clusters) {
            var value = cluster in genome.by_evidence_cluster ? genome.by_evidence_cluster[cluster][aspect] : 0;
            line.push(value)
        }        
        array.push(line)
    }
    var data = google.visualization.arrayToDataTable(array);

    var options = {
          title: 'Evolution of GO meta statements, xrefs and relations',
          subtitle: '',
          legend: { position: 'bottom' },
          crosshair: { focused: { color: '#3bc', opacity: 0.8 } },
          // curveType: 'function',
          dataOpacity: 1.0,
          width: 1000,
          height: 600,
          bar : { groupWidth: '75%' },
          isStacked : true,
          chartArea : {'width': '85%', 'height': '75%', top: 15},
          //   hAxis: { textPosition: 'in' },
          titlePosition: 'none'

      };

    var chart = new google.visualization.ColumnChart(document.getElementById('graph-genome-annotation-evidence'));        
    chart.draw(data, options);
}

function drawRefGenomeCoverageByAspect(statsObj, bioentityType, release) {
    var stats = statsObj["stats"];
    
    var header = ["Aspect", "A", "P", "F", "C"];

    // console.log("coverage by aspect: ", statsObj , bioentityType, release);

    var array = [];
    array.push(header);
    for(var genome_id in release.bioentities.by_model_organism) {
        var genome = release.bioentities.by_model_organism[genome_id];
        var btype = genome[bioentityType];
        array.push([genome_id.split("|")[1], btype ? btype["A"] : 0, btype ? btype["P"] : 0, btype ? btype["F"] : 0, btype ? btype["C"] : 0]);
    }
    var data = google.visualization.arrayToDataTable(array);

    var options = {
          title: 'Evolution of GO meta statements, xrefs and relations',
          subtitle: '',
          legend: { position: 'bottom' },
          crosshair: { focused: { color: '#3bc', opacity: 0.8 } },
          // curveType: 'function',
          dataOpacity: 1.0,
          width: 1000,
          height: 600,
          bar : { groupWidth: '75%' },
        //   isStacked : true,
        chartArea : {'width': '90%', 'height': '75%', top: 15},
        titlePosition: 'none'

      };

    var chart = new google.visualization.ColumnChart(document.getElementById('graph-genome-bioentity-coverage-aspect'));        
    chart.draw(data, options);
}


function drawAnnotationCharts(statsObj, release) {    
    // drawAnnotationAspectOT(statsObj)
    // drawAnnotationBioentityOT(statsObj)
    drawAnnotationEvidenceOT(statsObj)
}

function drawOntologyTableOverview(statsObj, release) {
    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Property');
    data.addColumn('string', 'Value');
    data.addRows([
        ["Valid terms", release.ontology.valid_terms + "\t(Δ = " + release.ontology.changes_valid_terms + ")"],
        ["Obsoleted terms", release.ontology.obsolete_terms + "\t(Δ = " + release.ontology.changes_obsolete_terms + ")"],
        ["Merged terms", release.ontology.merged_terms + "\t(Δ = " + release.ontology.changes_merged_terms + ")"],
        ["Biological process terms", release.ontology.biological_process_terms + ""],
        ["Molecular function terms", release.ontology.molecular_function_terms + ""],
        ["Cellular component terms", release.ontology.cellular_component_terms + ""],
    ]);

    var options = {
        showRowNumber: true, width: '100%', 
        height: '100%', 
        showRowNumber: false
    };

    var table = new google.visualization.Table(document.getElementById('stats-current-table-ontology-overview'));
    table.draw(data, options);    
}

function drawAnnotationTableOverview(statsObj, release) {
    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Property');
    data.addColumn('number', 'Value');
    var array = [
        ["Number of annotations", release.annotations.total],
        
        ["Annotations for biological process", release.annotations.by_aspect.P],
        ["Annotations for molecular function", release.annotations.by_aspect.F],
        ["Annotations for cellular component", release.annotations.by_aspect.C],        
    ]

    for(var evidence in release.annotations.by_evidence_cluster) {
        array.push(["Annotations for evidence " + evidence + "", release.annotations.by_evidence_cluster[evidence]]);
    }

    array.push(
        // ["Number of references", release.references.all.total],
        ["Number of annotated scientific publications", release.references.pmids.total]        
    )

    data.addRows(array)

    var options = {
        showRowNumber: true, width: '100%', 
        height: '100%', 
        showRowNumber: false
    };

    var table = new google.visualization.Table(document.getElementById('stats-current-table-annotation-overview'));
    table.draw(data, options);    
}

function drawBioentityTableOverview(statsObj, release) {
    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Property');
    data.addColumn('number', 'Value');
    var array = [
        ["Annotated gene products", release.bioentities.total],
        ["Annotated species", release.taxa.total],
        ["Annotated species with over 1,000 annotations", release.taxa.filtered]
    ]
    data.addRows(array)

    var options = {
        showRowNumber: true, width: '100%', 
        height: '100%', 
        showRowNumber: false
    };

    var table = new google.visualization.Table(document.getElementById('stats-current-table-bioentity-overview'));
    table.draw(data, options);    
}

function drawTableOverviews(statsObj, release) {
    drawOntologyTableOverview(statsObj, release);     
    drawAnnotationTableOverview(statsObj, release);
    drawBioentityTableOverview(statsObj, release);
}




function changeSpeciesFilter() {
    var selSpe = document.getElementById("annotation-evidence-species-filter");
    var newSpe = selSpe.options[selSpe.selectedIndex].value;
    if(newSpe != "All") {
        newSpe = dynamicTaxonMap[newSpe] + "|" + newSpe;
        drawAnnotationEvidenceOT(statsObj, newSpe);
    } else {
        drawAnnotationEvidenceOT(statsObj);
    }
}

function changeBioentity() {
    var selBio = document.getElementById("selected-bioentity");
    var newBio = selBio.options[selBio.selectedIndex].value;
    drawRefGenomeCoverageByAspect(statsObj, newBio, currentRelease)
}


function createStatsObj(stats) {
    var reference_genomes = {}
    Object.keys(stats[0].references.pmids.by_model_organism).forEach(elt => {
        var split = elt.split("|");
        reference_genomes[split[0]] = split[1];
    })

    var bioentity_types = Object.keys(stats[0].bioentities.by_type_cluster)

    var evidence_clusters = Object.keys(stats[0].annotations.by_evidence_cluster);

    var stats_obj = {
        stats : stats,
        reference_genomes : reference_genomes,
        bioentity_types : bioentity_types,
        evidence_clusters : evidence_clusters
    }

    return stats_obj;
}

var statsObj = undefined;
var currentRelease = undefined;
var lastRelease = undefined;
var dynamicTaxonMap = { };
var dynamicReleaseDate = { };


function setDynamicVariables() {
    // console.log("release: ", currentRelease);
    var release_h2 = document.getElementById("stats-current");
    // release_h2.innerHTML = "Release statistics (" + lastRelease.release_date + ")";
    release_h2.innerHTML = "Release statistics";

    var release_text = document.getElementById("release-date-text");
    release_text.innerHTML = lastRelease.release_date;

    for(var taxon_id in statsObj.reference_genomes) {
        dynamicTaxonMap[statsObj.reference_genomes[taxon_id]] = taxon_id;
    }
}

/**
 * executed only once at page startup
 * @param {*} statsObj 
 */
function initUI(statsObj) {
    setDynamicVariables();
    var selRelease = document.getElementById("selected-release");
    if(selRelease) {
        for(var release of statsObj.stats) {
            var sdate = simpleDate(release.release_date);
            dynamicReleaseDate[sdate] = release.release_date;
            selRelease.options[selRelease.options.length] = new Option(sdate);
        }
        selRelease.selectedIndex = selRelease.options.length - 1;
    }

    var selBio = document.getElementById("selected-bioentity");
    if(selBio) {
        for(var btype of statsObj.bioentity_types) {
            selBio.options[selBio.options.length] = new Option(btype);
        }
    }

    var selAspect = document.getElementById("annotation-filter-aspect");
    if(selAspect) {
        selAspect.options[selAspect.options.length] = new Option("All");
        selAspect.options[selAspect.options.length] = new Option("Biological process");
        selAspect.options[selAspect.options.length] = new Option("Molecular function");
        selAspect.options[selAspect.options.length] = new Option("Cellular component");
    }

    var selSpe = document.getElementById("annotation-evidence-species-filter");
    if(selSpe) {
        selSpe.options[selSpe.options.length] = new Option("All");
        for(var species in statsObj.reference_genomes) {
            selSpe.options[selSpe.options.length] = new Option(statsObj.reference_genomes[species]);
        }
    }
}



function changeAnnotationAspect() {
    var selAspect = document.getElementById("annotation-filter-aspect");
    var newAspect = selAspect.options[selAspect.selectedIndex].value;
    // console.log("setting aspect to ", newAspect);

    if(newAspect == "All") {
        newAspect = "A";
    } else if(newAspect == "Biological process") {
        newAspect = "P";
    } else if(newAspect == "Molecular function") {
        newAspect = "F";
    } else if(newAspect == "Cellular component") {
        newAspect = "C";
    }

    drawRefGenomeCoverageByEvidence(statsObj, newAspect, currentRelease);
}

function changeRelease() {
    var selRelease = document.getElementById("selected-release");
    var newRelease = selRelease.options[selRelease.selectedIndex].value;
    newRelease = dynamicReleaseDate[newRelease];
    // console.log("loading data for new release: ", newRelease);
    currentRelease = newRelease;
    var release = getRelease(statsObj, newRelease);

    var selAspect = document.getElementById("annotation-filter-aspect");
    if(selAspect) {
        selAspect.selectedIndex = 0;
    }

    drawRelease(release);
}


function drawRelease(release) {
    currentRelease = release;
    // console.log("Drawing release: ", release);

    drawTableOverviews(statsObj, release);

    drawOntologyCharts(statsObj, release);
    drawAnnotationCharts(statsObj, release);

    drawReferencePMIDsOT(statsObj);
}

var drawCharts = async function() {
    var stats = await initData();
    statsObj = createStatsObj(stats);
    // console.log("stats obj: ", statsObj);

    lastRelease = getLastRelease(statsObj);
    initUI(statsObj);

    drawRelease(lastRelease);
}


var initData = async function () {
    var stats = await get_aggregated_stats();
    stats = stats.data;    
    return stats;
}



